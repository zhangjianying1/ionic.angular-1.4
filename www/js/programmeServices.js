angular.module("starter.services",[]).factory("programmeServices",["globalServices","$state","$ionicPopup",function(e,o,t){return{programme:function(){var o=0;return function(t,r){r?o=r:o++,e.serialPost(2e3,"list",{page:o,pageSizepageSize:10}).then(function(o){return o.isOffLine?(t.$broadcast("scroll.refreshComplete"),void t.$broadcast("scroll.infiniteScrollComplete")):(o.programList.length<10&&(t.isMore=!1),r?(t.programmes=o.programList,t.$broadcast("scroll.refreshComplete")):(t.programmes=t.programmes.concat(o.programList),t.$broadcast("scroll.infiniteScrollComplete")),void e.cache("programme",t.programmes))})}}(),getProgramme:function(o){var t=e.cache("programme"),r={};return angular.forEach(t,function(e){e.programCode==o&&(r=e)}),r},getAccountBalance:function(o,t,r){e.post(3102,"account",{amount:t,lotteryCode:o}).then(function(e){r.account=e})},buyProgramme:function(r,a,n,i,s){function c(t,a){e.serialPost(3102,"password",{password:md5(t)}).then(function(e){e.isTrue?(d.close(),p()):0==e.errCount?(r.data.wring="您的账户已被锁定！",setTimeout(function(){d.close(),o.go("tab.login",{backURL:"tab.index"})},1e3)):r.data.wring="密码输入错误，您还有"+e.errCount+"次机会"})}function p(){var c=n-s<0?"0":n-s;e.serialPost(2e3,"buy",{programCode:a,amount:n,mcoin:c,couponCode:i||"",couponAmount:s||""}).then(function(e){t.show({template:'<div class="programme-success"><img src="./img/programme/chenggong.png" /><p>您选择的方案已订购成功<br/>祝您好运</p><style>.popup-body{overflow: visible;padding:0}</style></div>',scope:r,buttons:[{text:"取消"},{text:"确定",type:"c-red",onTap:function(t){o.go("tab.programmeorder",{orderCode:e.orderCode})}}]})})}r.data={};var d=t.show({template:'<div><p class="c-333 fs-15" style="margin: 15px 5px; padding-left:15px;border: 1px solid #ddd; border-radius:4px"><my-input><input type="password" id="password" ng-model="data.password" placeholder="登录密码" /></my-input></p><div class="c-red">{{data.wring}}</div></div>',title:"请输入您的登录密码",scope:r,buttons:[{text:"取消"},{text:"确定",type:"c-red",onTap:function(e){c(r.data.password,e),e.preventDefault()}}]})},getCoupon:function(o,t,r,a){o.default.index==o[t].flag&&(r?o[t].page=r:o[t].page+=1,e.serialPost("3202","limitList",{lotteryCode:o.default.lotteryCode,amount:o.default.amount,page:o[t].page,flag:o[t].flag,pageSize:10}).then(function(e){e.couponList.length<10&&(o[t].isMore=!1),o.$broadcast("scroll.infiniteScrollComplete"),1==o[t].page?(o[t].data=e.couponList,o.couponData.canUseSize=e.canUseSize,o.couponData.cantUseSize=e.cantUseSize,10==e.couponList.length&&(o[t].isMore=!0)):o[t].data=o[t].data.concat(e.couponList),a&&a()}))},getOrderDetail:function(o,t){e.post(2100,"detail",{orderCode:t}).then(function(t){t.order.bonusNumber=e.sliceNum(t.order.bonusNumber),o.orderDetail=t.order})}}}]);